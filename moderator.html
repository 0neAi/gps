<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Location Tracker Admin Dashboard</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./assets/css/main.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .container-fluid {
            padding: 20px;
        }
        .card {
            background-color: #2a2a4e;
            border: none;
            color: #e0e0e0;
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #3a3a5e;
            color: #ff69b4;
            font-weight: bold;
        }
        .table {
            color: #e0e0e0;
        }
        .table th {
            color: #ff69b4;
        }
        .btn-primary {
            background-color: #ff69b4;
            border-color: #ff69b4;
        }
        .btn-primary:hover {
            background-color: #ff416c;
            border-color: #ff416c;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status-pending {
            background-color: #ffc107;
            color: #000;
        }
        .status-approved {
            background-color: #198754;
            color: #fff;
        }
        .status-rejected {
            background-color: #dc3545;
            color: #fff;
        }
        .status-completed {
            background-color: #0d6efd;
            color: #fff;
        }
        .modal-content {
            background-color: #2a2a4e;
            color: #e0e0e0;
        }
        .modal-header {
            border-bottom-color: #3a3a5e;
        }
        .modal-footer {
            border-top-color: #3a3a5e;
        }
        .form-control {
            background-color: #1e1e3f;
            color: #e0e0e0;
            border-color: #3a3a5e;
        }
        .form-control:focus {
            background-color: #1e1e3f;
            color: #e0e0e0;
            border-color: #ff69b4;
            box-shadow: 0 0 0 0.25rem rgba(255, 105, 180, 0.25);
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: #2a2a4e;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        .loading-overlay i {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div id="admin-app" v-cloak>
        <div v-if="isLoading" class="loading-overlay">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Loading...</p>
        </div>

        <div v-if="!authenticated" class="login-container">
            <h2 class="text-center mb-4">Moderator Login</h2>
            <div v-if="loginError" class="alert alert-danger">{{ loginError }}</div>
            <form @submit.prevent="login">
                <div class="mb-3">
                    <label for="email" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="email" v-model="credentials.email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" v-model="credentials.password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
            </form>
        </div>

        <div v-else class="container-fluid">
            <h1 class="text-center my-4">Location Tracker Admin Dashboard</h1>
            <button @click="logout" class="btn btn-danger float-end">Logout</button>
            <button @click="loadData" class="btn btn-info float-end me-2">Refresh Data</button>
            <div class="clearfix mb-3"></div>

            <!-- Stats Section -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Requests</h5>
                            <p class="card-text fs-3">{{ stats.totalRequests }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Pending Requests</h5>
                            <p class="card-text fs-3">{{ stats.pendingRequests }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Completed Requests</h5>
                            <p class="card-text fs-3">{{ stats.completedRequests }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Requests Table -->
            <div class="card">
                <div class="card-header">Service Requests</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="requestFilter" class="form-label">Filter by Status:</label>
                        <select id="requestFilter" class="form-select" v-model="requestFilter">
                            <option value="all">All</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User Email</th>
                                    <th>Source Type</th>
                                    <th>Service Charge</th>
                                    <th>Status</th>
                                    <th>Submitted At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="request in filteredRequests" :key="request._id">
                                    <td>{{ request._id.slice(-6) }}</td>
                                    <td>{{ request.user ? request.user.email : 'N/A' }}</td>
                                    <td>{{ request.sourceType }}</td>
                                    <td>à§³{{ request.serviceCharge.toFixed(2) }}</td>
                                    <td><span :class="'status-badge status-' + request.status.toLowerCase()">{{ request.status }}</span></td>
                                    <td>{{ new Date(request.createdAt).toLocaleString() }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info me-1" @click="showRequestDetails(request)">Details</button>
                                        <button class="btn btn-sm btn-success" @click="showDeliverDataModal(request)">Deliver Data</button>
                                    </td>
                                </tr>
                                <tr v-if="filteredRequests.length === 0">
                                    <td colspan="7" class="text-center">No requests found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Request Details Modal -->
        <div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-labelledby="requestDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="requestDetailsModalLabel">Service Request Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" v-if="selectedRequest">
                        <p><strong>Request ID:</strong> {{ selectedRequest._id }}</p>
                        <p><strong>User Email:</strong> {{ selectedRequest.user ? selectedRequest.user.email : 'N/A' }}</p>
                        <p><strong>Source Type:</strong> {{ selectedRequest.sourceType }}</p>
                        <p v-if="selectedRequest.imei"><strong>IMEI:</strong> {{ selectedRequest.imei }}</p>
                        <p v-if="selectedRequest.phoneNumber"><strong>Phone Number:</strong> {{ selectedRequest.phoneNumber }}</p>
                        <p v-if="selectedRequest.lastUsedPhoneNumber"><strong>Last Used Phone:</strong> {{ selectedRequest.lastUsedPhoneNumber }}</p>
                        <p><strong>Requested Data:</strong> {{ selectedRequest.dataNeeded.join(', ') }}</p>
                        <p><strong>Service Types:</strong> {{ selectedRequest.serviceTypes.join(', ') }}</p>
                        <p><strong>Additional Note:</strong> {{ selectedRequest.additionalNote || 'N/A' }}</p>
                        <p><strong>Service Charge:</strong> à§³{{ selectedRequest.serviceCharge.toFixed(2) }}</p>
                        <p><strong>Payment Method:</strong> {{ selectedRequest.paymentMethod }}</p>
                        <p><strong>TRX ID:</strong> {{ selectedRequest.trxId }}</p>
                        <p><strong>Status:</strong> <span :class="'status-badge status-' + selectedRequest.status.toLowerCase()">{{ selectedRequest.status }}</span></p>
                        <p><strong>Submitted At:</strong> {{ new Date(selectedRequest.createdAt).toLocaleString() }}</p>
                        
                        <h6 class="mt-3">Delivered Data:</h6>
                        <div v-if="selectedRequest.deliveredData && selectedRequest.deliveredData.length > 0">
                            <div v-for="data in selectedRequest.deliveredData" :key="data._id" class="card mb-2">
                                <div class="card-body">
                                    <p><strong>Type:</strong> {{ data.dataType }}</p>
                                    <p><strong>Content:</strong> {{ JSON.stringify(data.dataContent) }}</p>
                                    <p><strong>Delivered By:</strong> {{ data.deliveredBy ? data.deliveredBy.email : 'N/A' }}</p>
                                    <p><strong>Delivered At:</strong> {{ new Date(data.deliveredAt).toLocaleString() }}</p>
                                </div>
                            </div>
                        </div>
                        <p v-else>No data delivered yet for this request.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deliver Data Modal -->
        <div class="modal fade" id="deliverDataModal" tabindex="-1" aria-labelledby="deliverDataModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deliverDataModalLabel">Deliver Data for Request {{ selectedRequest ? selectedRequest._id.slice(-6) : '' }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form @submit.prevent="deliverData">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="dataType" class="form-label">Data Type</label>
                                <select class="form-select" id="dataType" v-model="deliverDataForm.dataType" required>
                                    <option value="">Select Data Type</option>
                                    <option value="location">Location</option>
                                    <option value="nid">NID Card Details</option>
                                    <option value="callList">Call List</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="dataContent" class="form-label">Data Content (JSON or Text)</label>
                                <textarea class="form-control" id="dataContent" rows="5" v-model="deliverDataForm.dataContent" required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Deliver</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Admin App Script -->
    <script src="./assets/js/moderator.js"></script>
</body>
</html>